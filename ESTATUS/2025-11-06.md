# ESTATUS — 2025-11-06

## Resumen
- Objetivo: que varias empresas usen la app sin mezclar datos.
- Dos caminos posibles: (A) una copia por empresa usando `appId`, (B) una sola app multi‑empresa (multi‑tenant) con selector de empresa y roles por empresa.

## Opción A — Copia por empresa (rápida)
- Cada empresa usa un `VITE_APP_ID` distinto (ej.: `empresa-1`, `empresa-2`).
- La app ya guarda datos bajo `artifacts/{appId}/...`, así que quedan aislados por ese id.
- Pasos:
  - En `.env.local`: `VITE_APP_ID=<empresa-id>`
  - Desplegar/levantar la app para esa empresa.
  - Para dar rol admin: crear `admins/{UID}` o poner `role: "admin"` en `artifacts/{appId}/users/{UID}`.
- Pros: muy simple y ya funciona. Contras: hay que mantener una copia por empresa.

## Opción B — Una sola app multi‑empresa (recomendada a medio plazo)
- Estructura Firestore:
  - `tenants/{tenantId}`
    - `assets/{assetId}`
    - `inspections/{inspectionId}`
    - `members/{uid}` → `{ role: 'admin' | 'technician' }`
  - `superAdmins/{uid}` para el super usuario.
- App:
  - Super usuario ve un selector/creador de empresa y activa `tenantId` actual.
  - Usuarios normales pertenecen a 1 tenant por su doc en `members`.
- Reglas (borrador):
  - `isSuperAdmin = exists(/.../superAdmins/$(request.auth.uid))`
  - `isMember(t) = exists(/.../tenants/$(t)/members/$(request.auth.uid))`
  - `allow read: if isSuperAdmin || isMember(tenantId)`
  - `allow write en assets/inspections: if isSuperAdmin || (isMember(tenantId) && role in ['admin'])`
- Pros: un solo despliegue, mejor escalabilidad. Contras: requiere cambio de código (estimación 1–2 días).

## Cambios técnicos de hoy
- Se corrigieron errores de interfaz:
  - Importados íconos faltantes (`Loader`, `Target` con alias `TargetIcon`, etc.).
  - Eliminado estado local que ocultaba `db` importado y bloqueaba inicio.
  - Ajustada condición de carga para mostrar Login cuando corresponde.
  - Importado `Login` correctamente.
  - Agregado `DEFAULT_IV_IS_CHECKLIST` para evitar error al crear activos.
- Documentado cómo asignar rol admin:
  - Crear `admins/{UID}` o editar `artifacts/{appId}/users/{UID}` con `role: 'admin'`.

## Próximos pasos propuestos
1) Corto plazo: usar Opción A.
   - Crear despliegues con `VITE_APP_ID=empresa-1`, `empresa-2`, etc.
   - Entregar credenciales y asignar admins por empresa.
2) Medio plazo: migrar a Opción B.
   - Añadir selector de empresa para super usuario.
   - Migrar rutas a `tenants/{tenantId}/...` y roles por `members`.
   - Subir reglas nuevas de Firestore.

## Notas
- El encabezado de la app muestra `Entorno: <appId>` para verificar en qué "cajón" se están guardando los datos.
- Los avisos de navegador sobre COOP/COEP o `favicon.ico` no afectan la funcionalidad de negocio.

## Pasos para implementar Opción B (multi‑tenant)
- Preparación en Firestore
  - Crear colección raíz `superAdmins` y agregar tu UID.
  - Crear colección `tenants` y primer doc `tenants/{tenantId}` (p. ej. `empresa-1`).
  - Dentro de `tenants/{tenantId}` crear subcolecciones: `members`, `assets`, `inspections`.
  - En `members/{uid}` registrar a los usuarios con `{ role: 'admin' | 'technician', email, displayName, createdAt }`.
- Reglas de seguridad
  - Aplicar las reglas del archivo `ESTATUS/REGLAS_FIRESTORE.md` (sección Multi‑tenant).
  - Crear índice de `inspections` por `date desc`.
- Cambios en la app (frontend)
  - Agregar selector de empresa:
    - Si eres `superAdmin`, listar/crear tenants y guardar `tenantId` activo en `localStorage`.
    - Si no, solicitar `tenantId` y validar que `members/{uid}` exista en ese tenant.
  - Reemplazar rutas actuales:
    - `artifacts/{appId}/users/{uid}/assets` → `tenants/{tenantId}/assets`.
    - `artifacts/{appId}/users/{uid}/inspections` → `tenants/{tenantId}/inspections`.
    - Perfil/rol: `tenants/{tenantId}/members/{uid}`.
  - Roles:
    - `superAdmin` ve el selector y tiene acceso a todos los tenants.
    - `admin`/`technician` solo dentro del `tenantId` activo.
  - Cabecera: mostrar `Empresa: <tenantId>` junto a `Usuario` y `Rol`.
- Migración de datos (si ya hay información)
  - Copiar de `artifacts/{appId}` hacia `tenants/{tenantId}` (mapeo 1:1 usando el mismo valor como `tenantId`).
  - Migrar `role` de `users/{uid}` a `members/{uid}`.
- QA y despliegue
  - Probar: login, selección de empresa, crear activo, crear inspección, dashboard.
  - Desplegar en producción y comunicar IDs de empresa a cada cliente.
